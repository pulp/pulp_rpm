Refactored the sync pipeline to make the logic easier to follow.
