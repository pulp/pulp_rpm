Reduce memory consumption when syncing extremely large repositories.
(backported from #8467)
