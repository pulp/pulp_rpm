Vastly improved copy-with-depsolving performance.
(backported from #9387)
